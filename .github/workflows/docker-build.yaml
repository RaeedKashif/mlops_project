name: Simple Docker CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker
      run: |
        docker --version
        docker-compose --version
    
    - name: Build and test ingestion service
      run: |
        echo "ğŸ”§ Building ingestion service..."
        cd ingestion
        docker build -t ingestion:test .
        echo "âœ… ingestion service built successfully"
    
    - name: Build and test streamlit dashboard
      run: |
        echo "ğŸ“Š Building streamlit dashboard..."
        cd streamlit_app
        docker build -t dashboard:test .
        echo "âœ… streamlit dashboard built successfully"
    
    - name: Build and test FL server
      run: |
        echo "ğŸ¤– Building FL server..."
        cd federated_learning
        docker build -t fl-server:test .
        echo "âœ… FL server built successfully"
    
    - name: Build and test publisher
      run: |
        echo "ğŸ“¡ Building publisher..."
        cd publisher
        docker build -t publisher:test .
        echo "âœ… publisher built successfully"
    
    - name: Test docker-compose
      run: |
        echo "ğŸ³ Testing docker-compose..."
        if [ -f "docker-compose.yml" ]; then
          docker-compose config --quiet
          echo "âœ… docker-compose.yml is valid"
        else
          echo "âš ï¸ No docker-compose.yml found"
        fi
    
    - name: List all built images
      run: |
        echo "ğŸ“¦ Listing all Docker images:"
        docker images
    
    - name: Success
      run: |
        echo "ğŸ‰ All Docker images built successfully!"
        echo ""
        echo "âœ… Services ready:"
        echo "   - Ingestion API (port 8000)"
        echo "   - Streamlit Dashboard (port 8501)"
        echo "   - FL Server (port 8080)"
        echo "   - MQTT Publisher"
        echo ""
        echo "ğŸš€ To run locally:"
        echo "   docker-compose up -d"