name: Build and Push Docker Images

on:
  push:
    branches: [main]
  pull_request:
    branches: [ main]

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_PREFIX: iot

jobs:
  # Test job - runs on PRs and pushes
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test Dockerfiles exist
      run: |
        echo "üîç Checking project structure..."
        [ -f ingestion/Dockerfile ] && echo "‚úÖ ingestion/Dockerfile exists" || echo "‚ùå Missing ingestion/Dockerfile"
        [ -f ingestion/ingestion_service.py ] && echo "‚úÖ ingestion/ingestion_service.py exists" || echo "‚ùå Missing ingestion service"
        [ -f ingestion/requirements.txt ] && echo "‚úÖ ingestion/requirements.txt exists" || echo "‚ùå Missing ingestion requirements"
        
        [ -f publisher/Dockerfile ] && echo "‚úÖ publisher/Dockerfile exists" || echo "‚ùå Missing publisher/Dockerfile"
        [ -f publisher/mqtt_publisher.py ] && echo "‚úÖ publisher/mqtt_publisher.py exists" || echo "‚ùå Missing publisher script"
        
        [ -f streamlit_app/Dockerfile ] && echo "‚úÖ streamlit_app/Dockerfile exists" || echo "‚ùå Missing streamlit_app/Dockerfile"
        [ -f streamlit_app/streamlit_app.py ] && echo "‚úÖ streamlit_app/streamlit_app.py exists" || echo "‚ùå Missing streamlit app"
        [ -f streamlit_app/requirements.txt ] && echo "‚úÖ streamlit_app/requirements.txt exists" || echo "‚ùå Missing streamlit requirements"
        
        [ -f federated_learning/Dockerfile ] && echo "‚úÖ federated_learning/Dockerfile exists" || echo "‚ùå Missing FL Dockerfile"
        [ -f federated_learning/requirements.txt ] && echo "‚úÖ federated_learning/requirements.txt exists" || echo "‚ùå Missing FL requirements"
        [ -f federated_learning/server.py ] && echo "‚úÖ federated_learning/server.py exists" || echo "‚ùå Missing FL server"
        [ -f federated_learning/client.py ] && echo "‚úÖ federated_learning/client.py exists" || echo "‚ùå Missing FL client"
        [ -f federated_learning/model.py ] && echo "‚úÖ federated_learning/model.py exists" || echo "‚ùå Missing FL model"
        [ -f federated_learning/utils.py ] && echo "‚úÖ federated_learning/utils.py exists" || echo "‚ùå Missing FL utils"
    
    - name: Test Python syntax
      run: |
        echo "üß™ Testing Python syntax..."
        python3 -m py_compile ingestion/ingestion_service.py && echo "‚úÖ ingestion_service.py syntax OK"
        python3 -m py_compile publisher/mqtt_publisher.py && echo "‚úÖ mqtt_publisher.py syntax OK"
        python3 -m py_compile streamlit_app/streamlit_app.py && echo "‚úÖ streamlit_app.py syntax OK"
        python3 -m py_compile federated_learning/server.py && echo "‚úÖ server.py syntax OK"
        python3 -m py_compile federated_learning/client.py && echo "‚úÖ client.py syntax OK"
    
    - name: Test Docker builds (no push)
      run: |
        echo "üê≥ Testing Docker builds..."
        
        # Test build ingestion service
        echo "Building ingestion service..."
        docker build --no-cache -t test-ingestion ./ingestion/
        
        # Test build publisher
        echo "Building publisher..."
        docker build --no-cache -t test-publisher ./publisher/
        
        # Test build streamlit app
        echo "Building streamlit app..."
        docker build --no-cache -t test-streamlit ./streamlit_app/
        
        # Test build FL server
        echo "Building FL server..."
        docker build --no-cache -t test-fl-server ./federated_learning/
        
        echo "‚úÖ All Docker images built successfully!"

  # Build and push job - only runs on main branch push
  build-and-push:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      if: secrets.DOCKER_USERNAME != ''
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-ingestion
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-publisher
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-dashboard
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-fl-server
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
    
    - name: Build and push ingestion service
      uses: docker/build-push-action@v5
      with:
        context: ./ingestion
        push: ${{ secrets.DOCKER_USERNAME != '' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-ingestion:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-ingestion:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push publisher
      uses: docker/build-push-action@v5
      with:
        context: ./publisher
        push: ${{ secrets.DOCKER_USERNAME != '' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-publisher:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-publisher:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push streamlit dashboard
      uses: docker/build-push-action@v5
      with:
        context: ./streamlit_app
        push: ${{ secrets.DOCKER_USERNAME != '' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-dashboard:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-dashboard:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push FL server
      uses: docker/build-push-action@v5
      with:
        context: ./federated_learning
        push: ${{ secrets.DOCKER_USERNAME != '' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-fl-server:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-fl-server:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Verify pushed images
      if: secrets.DOCKER_USERNAME != ''
      run: |
        echo "üîç Verifying pushed images..."
        echo "Images available at:"
        echo "- ${{ secrets.DOCKER_USERNAME }}/iot-ingestion:latest"
        echo "- ${{ secrets.DOCKER_USERNAME }}/iot-publisher:latest"
        echo "- ${{ secrets.DOCKER_USERNAME }}/iot-dashboard:latest"
        echo "- ${{ secrets.DOCKER_USERNAME }}/iot-fl-server:latest"
    
    - name: Update deployment status
      run: |
        echo "üöÄ Build and push completed successfully!"
        echo "üì¶ Images are ready for deployment"
        echo ""
        echo "To deploy locally:"
        echo "  docker-compose up -d"
        echo ""
        echo "Or pull and run individual containers:"
        echo "  docker pull ${{ secrets.DOCKER_USERNAME }}/iot-ingestion:latest"
        echo "  docker pull ${{ secrets.DOCKER_USERNAME }}/iot-dashboard:latest"
        echo "  docker run -p 8501:8501 ${{ secrets.DOCKER_USERNAME }}/iot-dashboard:latest"

  # Deployment job (optional - for triggering deployments)
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Check deployment readiness
      run: |
        echo "‚úÖ All Docker images built and pushed successfully!"
        echo ""
        echo "üìã Next steps:"
        echo "1. Update your docker-compose.yml to use the new images:"
        echo "   image: ${{ secrets.DOCKER_USERNAME }}/iot-ingestion:latest"
        echo "   image: ${{ secrets.DOCKER_USERNAME }}/iot-dashboard:latest"
        echo "   etc..."
        echo ""
        echo "2. Deploy to your environment:"
        echo "   docker-compose pull"
        echo "   docker-compose up -d"
    
    - name: Send notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Build successful! Images are ready for deployment."
        else
          echo "‚ùå Build failed. Check the logs for details."
        fi