name: Build and Test Complete System

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build application images
      run: |
        echo "Building application images..."
        docker build -t my-ingestion ./ingestion/
        docker build -t my-dashboard ./streamlit_app/
        docker build -t my-fl-server ./federated_learning/
        docker build -t my-publisher ./publisher/
    
    - name: Test Prometheus config
      run: |
        echo "Testing Prometheus configuration..."
        if [ -f "monitoring/prometheus.yml" ]; then
          docker run --rm -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
            prom/prometheus:latest --config.file=/etc/prometheus/prometheus.yml --web.enable-lifecycle --check-config
          echo "‚úÖ Prometheus config is valid"
        else
          echo "‚ö†Ô∏è No Prometheus config found"
        fi
    
    - name: Test docker-compose
      run: |
        echo "Testing docker-compose configuration..."
        if [ -f "docker-compose.yml" ]; then
          docker-compose config
          echo "‚úÖ docker-compose config is valid"
        else
          echo "‚ö†Ô∏è No docker-compose.yml found"
        fi
    
    - name: Check monitoring endpoints
      run: |
        echo "Checking if monitoring endpoints are defined..."
        # Check if services expose Prometheus metrics ports
        grep -n "8001\|8081\|9090\|3000" docker-compose.yml || true
    
    - name: Summary
      run: |
        echo "üìä Build Summary:"
        echo "‚úÖ Application images built"
        echo "üîç Next steps to test monitoring:"
        echo "1. Add Prometheus/Grafana to docker-compose.yml"
        echo "2. Add metrics endpoints to your services"
        echo "3. Run: docker-compose up -d"
        echo "4. Access Grafana at http://localhost:3000"